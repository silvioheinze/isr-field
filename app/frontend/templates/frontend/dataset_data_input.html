{% extends 'frontend/_base.html' %}

{% block title %}Data Input - {{ dataset.name }}{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
<style>
    #map {
        height: 400px;
        width: 100%;
        border-radius: 8px;
        margin-bottom: 20px;
    }
    .geometry-details {
        background-color: #f8f9fa;
        padding: 20px;
        border-radius: 8px;
        margin-top: 20px;
        display: none;
    }
    .geometry-details.active {
        display: block;
    }
    .map-controls {
        position: absolute;
        top: 10px;
        right: 10px;
        z-index: 1000;
    }
    .selected-marker {
        background-color: #007bff !important;
        border: 3px solid #0056b3 !important;
    }
    .entry-card {
        margin-bottom: 15px;
    }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid mt-4">
    <!-- CSRF Token for JavaScript -->
    {% csrf_token %}
    
    <div class="row">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center mb-3">
                <h2>Data Input: {{ dataset.name }}</h2>
                <div>
                    <a href="{% url 'geometry_create' dataset.id %}" class="btn btn-success">Add Geometry Point</a>
                    <a href="{% url 'dataset_detail' dataset.id %}" class="btn btn-secondary">Back to Dataset</a>
                </div>
            </div>
        </div>
    </div>

    <!-- Map Section -->
    <div class="row">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0">Geometry Points Map</h5>
                    <small class="text-muted">Click on a point to view its details, or use "Add Point Mode" to create new geometry points</small>
                </div>
                <div class="card-body position-relative">
                    <div id="map"></div>
                    <div class="map-controls">
                        <button id="addPointBtn" class="btn btn-primary btn-sm">
                            <i class="bi bi-geo-alt"></i> Add Point Mode
                        </button>
                        <button id="currentLocationBtn" class="btn btn-info btn-sm mt-1">
                            <i class="bi bi-geo-alt-fill"></i> My Location
                        </button>
                        <button id="refreshDataBtn" class="btn btn-secondary btn-sm mt-1">
                            <i class="bi bi-arrow-clockwise"></i> Refresh Data
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Selected Geometry Details Section -->
    <div class="row">
        <div class="col-12">
            <div id="geometryDetails" class="geometry-details">
                <div class="d-flex justify-content-between align-items-start mb-3">
                    <h4 id="geometryTitle">Geometry Details</h4>
                    <button id="closeDetails" class="btn btn-sm btn-outline-secondary">×</button>
                </div>
                
                <div id="geometryInfo">
                    <!-- Geometry information will be populated by JavaScript -->
                </div>
                
                <div id="entriesSection" class="mt-4">
                    <h5>Data Entries</h5>
                    <div id="entriesList">
                        <!-- Entries will be populated by JavaScript -->
                    </div>
                    <div id="addEntrySection" class="mt-3">
                        <!-- Add entry button will be populated by JavaScript -->
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script>
    // Initialize map
    var map = L.map('map').setView([48.2082, 16.3738], 13); // Vienna coordinates as default

    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: '© OpenStreetMap contributors'
    }).addTo(map);

    // Global variables
    var mapData = [];
    var markers = [];
    var bounds = L.latLngBounds();
    var addPointMode = false;
    var tempMarker = null;
    var selectedMarker = null;
    var currentLocationMarker = null;
    var userLocation = null;

    // Load map data from API with optional bounds
    function loadMapData(mapBounds = null) {
        // Use full URL with current origin to avoid CORS issues
        var url = window.location.origin + '/datasets/{{ dataset.id }}/map-data/';
        if (mapBounds) {
            var boundsStr = mapBounds.getSouth() + ',' + mapBounds.getWest() + ',' + 
                           mapBounds.getNorth() + ',' + mapBounds.getEast();
            url += '?bounds=' + encodeURIComponent(boundsStr);
        }
        
        console.log('Making request to:', url);
        console.log('Current location:', window.location.href);
        
        return fetch(url, {
            credentials: 'same-origin'  // Include cookies for authentication
        })
            .then(response => {
                if (!response.ok) {
                    throw new Error('HTTP ' + response.status + ': ' + response.statusText);
                }
                return response.json();
            })
            .then(data => {
                if (!data || !data.map_data) {
                    throw new Error('Invalid data format received');
                }
                mapData = data.map_data;
                addMarkersToMap();
            })
            .catch(error => {
                console.error('Error loading map data:', error);
                alert('Error loading map data: ' + error.message);
                throw error;
            });
    }

    // Add markers to map
    function addMarkersToMap() {
        // Clear existing markers
        markers.forEach(marker => map.removeLayer(marker));
        markers = [];
        bounds = L.latLngBounds();

        mapData.forEach(function(point) {
            var marker = L.marker([point.lat, point.lng])
                .bindPopup(`
                    <strong>${point.id_kurz}</strong><br>
                    ${point.address}<br>
                    Entries: ${point.entries_count}
                `)
                .addTo(map);
            
            // Add click handler to show geometry details
            marker.on('click', function() {
                showGeometryDetails(point, marker);
            });
            
            markers.push(marker);
            bounds.extend([point.lat, point.lng]);
        });

        // Fit map to show all markers
        if (markers.length > 0) {
            map.fitBounds(bounds);
        }
    }

    // Get user location and initialize map
    function initializeMapWithUserLocation() {
        if (navigator.geolocation) {
            // Show loading state
            document.getElementById('refreshDataBtn').innerHTML = '<i class="bi bi-hourglass-split"></i> Getting Location...';
            document.getElementById('refreshDataBtn').disabled = true;
            
            navigator.geolocation.getCurrentPosition(
                function(position) {
                    var lat = position.coords.latitude;
                    var lng = position.coords.longitude;
                    userLocation = {lat: lat, lng: lng};
                    
                    // Zoom to user location at highest level (zoom 18)
                    map.setView([lat, lng], 18);
                    
                    // Create a small bounds around user location
                    var userBounds = L.latLngBounds(
                        [lat - 0.001, lng - 0.001], // Small offset for bounds
                        [lat + 0.001, lng + 0.001]
                    );
                    
                    // Load data for the visible area
                    loadMapData(userBounds).then(() => {
                        // Reset button
                        document.getElementById('refreshDataBtn').innerHTML = '<i class="bi bi-arrow-clockwise"></i> Refresh Data';
                        document.getElementById('refreshDataBtn').disabled = false;
                    }).catch(() => {
                        // Reset button on error
                        document.getElementById('refreshDataBtn').innerHTML = '<i class="bi bi-arrow-clockwise"></i> Refresh Data';
                        document.getElementById('refreshDataBtn').disabled = false;
                    });
                },
                function(error) {
                    // If geolocation fails, load all data with default view
                    console.log('Geolocation failed, loading all data');
                    loadMapData().then(() => {
                        // Reset button
                        document.getElementById('refreshDataBtn').innerHTML = '<i class="bi bi-arrow-clockwise"></i> Refresh Data';
                        document.getElementById('refreshDataBtn').disabled = false;
                    }).catch(() => {
                        // Reset button on error
                        document.getElementById('refreshDataBtn').innerHTML = '<i class="bi bi-arrow-clockwise"></i> Refresh Data';
                        document.getElementById('refreshDataBtn').disabled = false;
                    });
                },
                {
                    enableHighAccuracy: true,
                    timeout: 10000,
                    maximumAge: 60000
                }
            );
        } else {
            // Geolocation not supported, load all data
            loadMapData();
        }
    }

    // Initialize map with user location
    initializeMapWithUserLocation();

    // Auto-load data when map is moved (with debouncing)
    var mapMoveTimeout;
    map.on('moveend', function() {
        // Clear previous timeout
        clearTimeout(mapMoveTimeout);
        
        // Set new timeout to avoid too many requests
        mapMoveTimeout = setTimeout(function() {
            var currentBounds = map.getBounds();
            loadMapData(currentBounds);
        }, 500); // Wait 500ms after user stops moving the map
    });

    // Refresh data button - now loads data for current map bounds
    document.getElementById('refreshDataBtn').addEventListener('click', function() {
        // Show loading state
        this.innerHTML = '<i class="bi bi-hourglass-split"></i> Loading...';
        this.disabled = true;
        
        // Clear current selection
        if (selectedMarker) {
            selectedMarker.getElement().classList.remove('selected-marker');
            selectedMarker = null;
        }
        document.getElementById('geometryDetails').classList.remove('active');
        
        // Get current map bounds and reload data
        var currentBounds = map.getBounds();
        loadMapData(currentBounds).then(() => {
            // Reset button
            this.innerHTML = '<i class="bi bi-arrow-clockwise"></i> Refresh Data';
            this.disabled = false;
        }).catch(() => {
            // Reset button on error
            this.innerHTML = '<i class="bi bi-arrow-clockwise"></i> Refresh Data';
            this.disabled = false;
        });
    });

    // Function to show geometry details
    function showGeometryDetails(point, marker) {
        // Remove previous selection
        if (selectedMarker) {
            selectedMarker.getElement().classList.remove('selected-marker');
        }
        
        // Mark current selection
        selectedMarker = marker;
        marker.getElement().classList.add('selected-marker');
        
        // Show details section
        document.getElementById('geometryDetails').classList.add('active');
        
        // Populate geometry information
        document.getElementById('geometryTitle').textContent = point.id_kurz + ' - ' + point.address;
        
        var geometryInfo = `
            <div class="row">
                <div class="col-md-6">
                    <p><strong>ID:</strong> ${point.id_kurz}</p>
                    <p><strong>Address:</strong> ${point.address}</p>
                    <p><strong>Coordinates:</strong> ${point.lat.toFixed(6)}, ${point.lng.toFixed(6)}</p>
                </div>
                <div class="col-md-6">
                    <p><strong>Total Entries:</strong> ${point.entries_count}</p>
                    <p><strong>Created by:</strong> ${point.user || 'Unknown'}</p>
                </div>
            </div>
        `;
        document.getElementById('geometryInfo').innerHTML = geometryInfo;
        
        // Populate entries
        var entriesHtml = '';
        if (point.entries && point.entries.length > 0) {
            entriesHtml = '<div class="row">';
            point.entries.forEach(function(entry) {
                entriesHtml += `
                    <div class="col-md-6 col-lg-4">
                        <div class="card entry-card">
                            <div class="card-body">
                                <h6 class="card-title">${entry.name}</h6>
                                <p class="card-text">
                                    <small class="text-muted">
                                        Year: ${entry.year}<br>
                                        Usage Codes: ${entry.usage_code1}, ${entry.usage_code2}, ${entry.usage_code3}<br>
                                        Categories: ${entry.cat_inno}, ${entry.cat_wert}, ${entry.cat_fili}<br>
                                        Created by: ${entry.user || 'Unknown'}
                                    </small>
                                </p>
                                <div class="btn-group w-100" role="group">
                                    <a href="/entries/${entry.id}/" class="btn btn-sm btn-outline-info">View Details</a>
                                    <a href="/entries/${entry.id}/edit/" class="btn btn-sm btn-outline-secondary">Edit</a>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            });
            entriesHtml += '</div>';
        } else {
            entriesHtml = '<p class="text-muted">No entries for this geometry.</p>';
        }
        document.getElementById('entriesList').innerHTML = entriesHtml;
        
        // Add entry button
        document.getElementById('addEntrySection').innerHTML = `
            <a href="/geometries/${point.id}/entries/create/" class="btn btn-success">Add Entry</a>
        `;
    }

    // Close details button
    document.getElementById('closeDetails').addEventListener('click', function() {
        document.getElementById('geometryDetails').classList.remove('active');
        if (selectedMarker) {
            selectedMarker.getElement().classList.remove('selected-marker');
            selectedMarker = null;
        }
    });

    // Current location functionality
    document.getElementById('currentLocationBtn').addEventListener('click', function() {
        if (navigator.geolocation) {
            // Show loading state
            this.innerHTML = '<i class="bi bi-hourglass-split"></i> Locating...';
            this.disabled = true;
            
            navigator.geolocation.getCurrentPosition(
                function(position) {
                    var lat = position.coords.latitude;
                    var lng = position.coords.longitude;
                    
                    // Remove previous current location marker
                    if (currentLocationMarker) {
                        map.removeLayer(currentLocationMarker);
                    }
                    
                    // Add current location marker
                    currentLocationMarker = L.marker([lat, lng], {
                        icon: L.divIcon({
                            className: 'current-location-marker',
                            html: '<div style="background-color: #28a745; width: 20px; height: 20px; border-radius: 50%; border: 3px solid white; box-shadow: 0 0 10px rgba(0,0,0,0.3);"></div>'
                        })
                    }).addTo(map);
                    
                    // Add popup with coordinates
                    currentLocationMarker.bindPopup(`
                        <strong>Your Location</strong><br>
                        Latitude: ${lat.toFixed(6)}<br>
                        Longitude: ${lng.toFixed(6)}<br>
                        Accuracy: ${position.coords.accuracy ? position.coords.accuracy.toFixed(1) + 'm' : 'Unknown'}
                    `);
                    
                    // Zoom to current location
                    map.setView([lat, lng], 16);
                    
                    // Load data for the area around current location
                    var locationBounds = L.latLngBounds(
                        [lat - 0.01, lng - 0.01], // Larger area for "My Location"
                        [lat + 0.01, lng + 0.01]
                    );
                    loadMapData(locationBounds);
                    
                    // Reset button
                    document.getElementById('currentLocationBtn').innerHTML = '<i class="bi bi-geo-alt-fill"></i> My Location';
                    document.getElementById('currentLocationBtn').disabled = false;
                },
                function(error) {
                    // Handle errors
                    var errorMessage = 'Unable to get your location';
                    switch(error.code) {
                        case error.PERMISSION_DENIED:
                            errorMessage = 'Location access denied. Please allow location access in your browser.';
                            break;
                        case error.POSITION_UNAVAILABLE:
                            errorMessage = 'Location information unavailable.';
                            break;
                        case error.TIMEOUT:
                            errorMessage = 'Location request timed out.';
                            break;
                        case error.UNKNOWN_ERROR:
                            errorMessage = 'An unknown error occurred.';
                            break;
                    }
                    alert(errorMessage);
                    
                    // Reset button
                    document.getElementById('currentLocationBtn').innerHTML = '<i class="bi bi-geo-alt-fill"></i> My Location';
                    document.getElementById('currentLocationBtn').disabled = false;
                },
                {
                    enableHighAccuracy: true,
                    timeout: 10000,
                    maximumAge: 60000
                }
            );
        } else {
            alert('Geolocation is not supported by this browser.');
        }
    });

    // Add point mode functionality
    document.getElementById('addPointBtn').addEventListener('click', function() {
        addPointMode = !addPointMode;
        this.textContent = addPointMode ? 'Cancel Add Point' : 'Add Point Mode';
        this.className = addPointMode ? 'btn btn-warning btn-sm' : 'btn btn-primary btn-sm';
        
        if (addPointMode) {
            map.getContainer().style.cursor = 'crosshair';
        } else {
            map.getContainer().style.cursor = '';
            if (tempMarker) {
                map.removeLayer(tempMarker);
                tempMarker = null;
            }
        }
    });

    // Handle map clicks for adding new points
    map.on('click', function(e) {
        if (addPointMode) {
            var lat = e.latlng.lat;
            var lng = e.latlng.lng;
            
            // Remove previous temp marker
            if (tempMarker) {
                map.removeLayer(tempMarker);
            }
            
            // Add temporary marker
            tempMarker = L.marker([lat, lng], {
                icon: L.divIcon({
                    className: 'temp-marker',
                    html: '<div style="background-color: red; width: 20px; height: 20px; border-radius: 50%; border: 2px solid white;"></div>'
                })
            }).addTo(map);
            
            // Show form to create new geometry
            var address = prompt('Enter address for this point:');
            if (address && address.trim() !== '') {
                var idKurz = prompt('Enter ID (id_kurz):');
                if (idKurz && idKurz.trim() !== '') {
                    // Create form and submit
                    var form = document.createElement('form');
                    form.method = 'POST';
                    form.action = '{% url "geometry_create" dataset.id %}';
                    
                    // Get CSRF token
                    var csrfToken = document.querySelector('[name=csrfmiddlewaretoken]').value;
                    var csrfInput = document.createElement('input');
                    csrfInput.type = 'hidden';
                    csrfInput.name = 'csrfmiddlewaretoken';
                    csrfInput.value = csrfToken;
                    form.appendChild(csrfInput);
                    
                    var inputs = [
                        {name: 'address', value: address.trim()},
                        {name: 'id_kurz', value: idKurz.trim()},
                        {name: 'lat', value: lat},
                        {name: 'lng', value: lng}
                    ];
                    
                    inputs.forEach(function(input) {
                        var inputElement = document.createElement('input');
                        inputElement.type = 'hidden';
                        inputElement.name = input.name;
                        inputElement.value = input.value;
                        form.appendChild(inputElement);
                    });
                    
                    document.body.appendChild(form);
                    form.submit();
                } else {
                    alert('ID is required.');
                }
            } else {
                alert('Address is required.');
            }
            
            // Reset add point mode
            addPointMode = false;
            document.getElementById('addPointBtn').textContent = 'Add Point Mode';
            document.getElementById('addPointBtn').className = 'btn btn-primary btn-sm';
            map.getContainer().style.cursor = '';
        }
    });
</script>
{% endblock %} 