{% extends 'datasets/_base.html' %}

{% block title %}{{ title }} - {{ dataset.name }}{% endblock %}

{% block content %}
<div class="container py-4" style="max-width: 960px;">
    <div class="d-flex flex-column flex-lg-row align-items-lg-center justify-content-between gap-3 mb-4">
        <div>
            <h1 class="h3 mb-1">{{ title }}</h1>
            <p class="text-muted small mb-0">Configure how the <strong>{{ dataset.name }}</strong> dataset captures this field in data entry.</p>
        </div>
        <div class="d-flex flex-wrap gap-2">
            <a href="{% url 'dataset_detail' dataset.id %}" class="btn btn-outline-secondary btn-sm">
                <i class="bi bi-arrow-left"></i> Back to Field Configuration
            </a>
        </div>
    </div>

    {% if form.errors %}
    <div class="alert alert-danger alert-dismissible fade show" role="alert">
        <h5 class="alert-heading"><i class="bi bi-exclamation-triangle me-2"></i>Form Errors</h5>
        {% if form.non_field_errors %}
            <ul class="mb-0">
                {% for error in form.non_field_errors %}
                    <li>{{ error }}</li>
                {% endfor %}
            </ul>
        {% else %}
            <p class="mb-0">Please correct the errors below and try again.</p>
        {% endif %}
        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
    </div>
    {% endif %}

    <form method="post" novalidate>
        {% csrf_token %}

        <div class="card shadow-sm mb-4">
            <div class="card-header bg-light fw-semibold">
                <i class="bi bi-info-circle me-2"></i>Basic Field Details
            </div>
            <div class="card-body">
                <div class="row g-4">
                    <div class="col-md-6" id="fieldNameGroup">
                        <label for="{{ form.field_name.id_for_label }}" class="form-label">Field Name</label>
                        {{ form.field_name }}
                        {% if form.field_name.help_text %}
                            <div class="form-text">{{ form.field_name.help_text }}</div>
                        {% endif %}
                        {% if form.field_name.errors %}
                            <div class="text-danger small mt-1">
                                {% for error in form.field_name.errors %}{{ error }}{% endfor %}
                            </div>
                        {% endif %}
                    </div>
                    <div class="col-md-6" id="displayLabelGroup">
                        <label for="{{ form.label.id_for_label }}" class="form-label">Display Label</label>
                        {{ form.label }}
                        {% if form.label.help_text %}
                            <div class="form-text">{{ form.label.help_text }}</div>
                        {% endif %}
                        {% if form.label.errors %}
                            <div class="text-danger small mt-1">
                                {% for error in form.label.errors %}{{ error }}{% endfor %}
                            </div>
                        {% endif %}
                    </div>

                    <div class="col-md-6">
                        <label for="{{ form.field_type.id_for_label }}" class="form-label">Field Type</label>
                        {{ form.field_type }}
                        {% if form.field_type.help_text %}
                            <div class="form-text">{{ form.field_type.help_text }}</div>
                        {% endif %}
                        {% if form.field_type.errors %}
                            <div class="text-danger small mt-1">
                                {% for error in form.field_type.errors %}{{ error }}{% endfor %}
                            </div>
                        {% endif %}
                    </div>
                    <div class="col-md-6">
                        <label for="{{ form.order.id_for_label }}" class="form-label">Display Order</label>
                        {{ form.order }}
                        {% if form.order.help_text %}
                            <div class="form-text">{{ form.order.help_text }}</div>
                        {% else %}
                            <div class="form-text">Lower numbers appear earlier in data entry forms. Use -1 for last position.</div>
                        {% endif %}
                        {% if form.order.errors %}
                            <div class="text-danger small mt-1">
                                {% for error in form.order.errors %}{{ error }}{% endfor %}
                            </div>
                        {% endif %}
                    </div>

                    <div class="col-12">
                        <label for="{{ form.help_text.id_for_label }}" class="form-label">Help Text</label>
                        {{ form.help_text }}
                        {% if form.help_text.help_text %}
                            <div class="form-text">{{ form.help_text.help_text }}</div>
                        {% else %}
                            <div class="form-text">Optional guidance displayed to editors beneath the field.</div>
                        {% endif %}
                        {% if form.help_text.errors %}
                            <div class="text-danger small mt-1">
                                {% for error in form.help_text.errors %}{{ error }}{% endfor %}
                            </div>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>

        <!-- Hidden fields to preserve values for required, enabled, and special field flags -->
        <!-- For checkboxes: include "on" if True, omit if False (Django interprets missing as False) -->
        {% if form.required.value %}
        <input type="hidden" name="required" value="on" id="id_required">
        {% elif form.instance.pk and form.instance.required %}
        <input type="hidden" name="required" value="on" id="id_required">
        {% endif %}
        {% if form.enabled.value %}
        <input type="hidden" name="enabled" value="on" id="id_enabled">
        {% elif not form.instance.pk or form.instance.enabled %}
        <input type="hidden" name="enabled" value="on" id="id_enabled">
        {% endif %}
        {% if form.is_coordinate_field.value %}
        <input type="hidden" name="is_coordinate_field" value="on" id="id_is_coordinate_field">
        {% elif form.instance.pk and form.instance.is_coordinate_field %}
        <input type="hidden" name="is_coordinate_field" value="on" id="id_is_coordinate_field">
        {% endif %}
        {% if form.is_id_field.value %}
        <input type="hidden" name="is_id_field" value="on" id="id_is_id_field">
        {% elif form.instance.pk and form.instance.is_id_field %}
        <input type="hidden" name="is_id_field" value="on" id="id_is_id_field">
        {% endif %}
        {% if form.is_address_field.value %}
        <input type="hidden" name="is_address_field" value="on" id="id_is_address_field">
        {% elif form.instance.pk and form.instance.is_address_field %}
        <input type="hidden" name="is_address_field" value="on" id="id_is_address_field">
        {% endif %}

        <!-- Choice & Typology Options - only shown when field_type is "choice" -->
        <div class="card shadow-sm mb-4" id="choiceOptionsCard" style="display: none;">
            <div class="card-header bg-light fw-semibold">
                <i class="bi bi-list-check me-2"></i>Choice &amp; Typology Options
            </div>
            <div class="card-body">
                <div class="mb-3">
                    <label class="form-label fw-semibold">Choice Source</label>
                    <div class="btn-group w-100" role="group" id="choiceSourceToggle">
                        <input type="radio" class="btn-check" name="choice_source" id="choiceSourceManual" value="manual" autocomplete="off" checked>
                        <label class="btn btn-outline-primary" for="choiceSourceManual">
                            <i class="bi bi-pencil"></i> Manual Choices
                        </label>
                        <input type="radio" class="btn-check" name="choice_source" id="choiceSourceTypology" value="typology" autocomplete="off">
                        <label class="btn btn-outline-primary" for="choiceSourceTypology">
                            <i class="bi bi-diagram-3"></i> Typology
                        </label>
                    </div>
                </div>

                <div id="manualChoicesSection">
                    <div class="row g-4">
                        <div class="col-12">
                            <label for="{{ form.choices.id_for_label }}" class="form-label">Manual Choices</label>
                            {{ form.choices }}
                            <div class="form-text">Provide a comma-separated list of options (e.g., "Option 1, Option 2, Option 3").</div>
                            {% if form.choices.errors %}
                                <div class="text-danger small mt-1">
                                    {% for error in form.choices.errors %}{{ error }}{% endfor %}
                                </div>
                            {% endif %}
                        </div>
                    </div>
                </div>

                <div id="typologySection" style="display: none;">
                    <div class="row g-4">
                        <div class="col-md-6">
                            <label for="{{ form.typology.id_for_label }}" class="form-label">Typology</label>
                            {{ form.typology }}
                            <div class="form-text">Select a typology to automatically populate dropdown values.</div>
                            {% if form.typology.errors %}
                                <div class="text-danger small mt-1">
                                    {% for error in form.typology.errors %}{{ error }}{% endfor %}
                                </div>
                            {% endif %}
                        </div>

                        <div class="col-md-6">
                            <label for="{{ form.typology_category.id_for_label }}" class="form-label">Typology Category</label>
                            {{ form.typology_category }}
                            <div class="form-text">Optionally limit choices to a single category within the typology.</div>
                            {% if form.typology_category.errors %}
                                <div class="text-danger small mt-1">
                                    {% for error in form.typology_category.errors %}{{ error }}{% endfor %}
                                </div>
                            {% endif %}
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="d-flex flex-wrap gap-2 justify-content-end">
            <a href="{% url 'dataset_detail' dataset.id %}" class="btn btn-outline-secondary">
                <i class="bi bi-x-circle"></i> Cancel
            </a>
            <button type="submit" class="btn btn-primary">
                <i class="bi bi-check-circle"></i> Save Field
            </button>
        </div>
    </form>
</div>

{{ typology_categories|json_script:"typologyCategoriesData" }}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        var fieldTypeSelect = document.getElementById('id_field_type');
        var choiceOptionsCard = document.getElementById('choiceOptionsCard');
        var manualChoicesSection = document.getElementById('manualChoicesSection');
        var typologySection = document.getElementById('typologySection');
        var choiceSourceManual = document.getElementById('choiceSourceManual');
        var choiceSourceTypology = document.getElementById('choiceSourceTypology');
        var typologySelect = document.getElementById('id_typology');
        var categorySelect = document.getElementById('id_typology_category');
        var choicesField = document.getElementById('id_choices');
        var fieldNameInput = document.getElementById('id_field_name');
        var labelInput = document.getElementById('id_label');
        var orderInput = document.getElementById('id_order');
        var nextOrder = {{ next_order|default:0 }};
        var orderInput = document.getElementById('id_order');
        var nextOrder = {{ next_order|default:0 }};

        // Typology categories data
        var categoriesElement = document.getElementById('typologyCategoriesData');
        var categoriesData = {};
        if (categoriesElement && categoriesElement.textContent) {
            try {
                categoriesData = JSON.parse(categoriesElement.textContent);
            } catch (err) {
                categoriesData = {};
            }
        }

        // Function to show/hide choice options based on field type
        function toggleChoiceOptions() {
            if (fieldTypeSelect && choiceOptionsCard) {
                if (fieldTypeSelect.value === 'choice' || fieldTypeSelect.value === 'multiple_choice') {
                    choiceOptionsCard.style.display = 'block';
                } else {
                    choiceOptionsCard.style.display = 'none';
                }
            }
        }

        // Function to show/hide field name (headline uses auto-generated headline_1, headline_2, etc.)
        function toggleFieldNameVisibility() {
            var fieldNameGroup = document.getElementById('fieldNameGroup');
            if (fieldNameGroup && fieldTypeSelect) {
                if (fieldTypeSelect.value === 'headline') {
                    fieldNameGroup.style.display = 'none';
                    if (fieldNameInput) fieldNameInput.value = '';
                } else {
                    fieldNameGroup.style.display = 'block';
                }
            }
        }

        // Function to toggle between manual choices and typology
        function toggleChoiceSource() {
            if (!manualChoicesSection || !typologySection) return;

            if (choiceSourceTypology && choiceSourceTypology.checked) {
                // Show typology, hide manual choices
                manualChoicesSection.style.display = 'none';
                typologySection.style.display = 'block';
                // Clear manual choices when switching to typology
                if (choicesField) {
                    choicesField.value = '';
                }
            } else {
                // Show manual choices, hide typology
                manualChoicesSection.style.display = 'block';
                typologySection.style.display = 'none';
                // Clear typology when switching to manual
                if (typologySelect) {
                    typologySelect.value = '';
                }
                if (categorySelect) {
                    categorySelect.value = '';
                }
            }
        }

        // Function to render category options based on selected typology
        function renderCategoryOptions() {
            if (!categorySelect || !typologySelect) return;

            var currentValue = categorySelect.value;
            var typologyId = typologySelect.value || '';
            var options = categoriesData[typologyId] || [];

            categorySelect.innerHTML = '';

            var defaultOption = document.createElement('option');
            defaultOption.value = '';
            defaultOption.textContent = 'All categories';
            categorySelect.appendChild(defaultOption);

            options.forEach(function(category) {
                var option = document.createElement('option');
                option.value = category;
                option.textContent = category;
                categorySelect.appendChild(option);
            });

            if (options.includes(currentValue)) {
                categorySelect.value = currentValue;
            } else {
                categorySelect.value = '';
            }
        }

        // Initialize: Check if typology is already selected and set the radio button accordingly
        function initializeChoiceSource() {
            if (typologySelect && typologySelect.value) {
                // Typology is selected, switch to typology mode
                if (choiceSourceTypology) {
                    choiceSourceTypology.checked = true;
                    choiceSourceManual.checked = false;
                }
            } else {
                // No typology selected, use manual mode
                if (choiceSourceManual) {
                    choiceSourceManual.checked = true;
                    choiceSourceTypology.checked = false;
                }
            }
            toggleChoiceSource();
        }

        // Event listeners
        if (fieldTypeSelect) {
            fieldTypeSelect.addEventListener('change', function() {
                toggleChoiceOptions();
                toggleFieldNameVisibility();
            });
            toggleChoiceOptions(); // Initial call
            toggleFieldNameVisibility(); // Initial call
        }

        if (choiceSourceManual) {
            choiceSourceManual.addEventListener('change', toggleChoiceSource);
        }
        if (choiceSourceTypology) {
            choiceSourceTypology.addEventListener('change', toggleChoiceSource);
        }

        if (typologySelect) {
            typologySelect.addEventListener('change', function() {
                renderCategoryOptions();
                // If typology is selected, switch to typology mode
                if (typologySelect.value && choiceSourceTypology) {
                    choiceSourceTypology.checked = true;
                    choiceSourceManual.checked = false;
                    toggleChoiceSource();
                }
            });
        }

        // Auto-fill field_name and label when typology_category is selected
        if (categorySelect) {
            categorySelect.addEventListener('change', function() {
                var selectedCategory = categorySelect.value;
                if (selectedCategory && fieldNameInput && labelInput) {
                    // Only auto-fill if fields are empty (to avoid overwriting user input)
                    if (!fieldNameInput.value || fieldNameInput.value.trim() === '') {
                        // Convert category name to field_name format (lowercase, replace spaces with underscores)
                        var fieldName = selectedCategory.toLowerCase().replace(/\s+/g, '_').replace(/[^a-z0-9_]/g, '');
                        // Ensure it starts with a letter
                        if (fieldName && !fieldName[0].match(/[a-z]/)) {
                            fieldName = 'field_' + fieldName;
                        }
                        fieldNameInput.value = fieldName;
                    }
                    if (!labelInput.value || labelInput.value.trim() === '') {
                        labelInput.value = selectedCategory;
                    }
                }
            });
        }

        // Auto-calculate next order when -1 is entered
        if (orderInput) {
            orderInput.addEventListener('change', function() {
                var orderValue = parseInt(orderInput.value);
                if (orderValue === -1) {
                    orderInput.value = nextOrder;
                }
            });
            orderInput.addEventListener('blur', function() {
                var orderValue = parseInt(orderInput.value);
                if (orderValue === -1) {
                    orderInput.value = nextOrder;
                }
            });
        }

        // Initialize on page load
        initializeChoiceSource();
        renderCategoryOptions();
    });
</script>
{% endblock %}