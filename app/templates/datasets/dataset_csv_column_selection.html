{% extends 'datasets/_base.html' %}

{% block title %}Select CSV Columns - {{ dataset.name }}{% endblock %}

{% block content %}
<div class="container py-4">
    <div class="d-flex flex-column flex-lg-row align-items-lg-center justify-content-between gap-3 mb-4">
        <div>
            <h1 class="h3 mb-1">Select CSV Columns</h1>
            <p class="text-muted small mb-0">Map identifiers and coordinate options for <strong>{{ dataset.name }}</strong>.</p>
        </div>
        <div class="d-flex flex-wrap gap-2">
            <a href="{% url 'dataset_csv_import' dataset.id %}" class="btn btn-outline-secondary btn-sm">
                <i class="bi bi-arrow-left"></i> Back to Upload
            </a>
        </div>
    </div>

    <div class="row g-4">
        <div class="col-lg-8">
            {% if detected_delimiter %}
            <div class="alert alert-info d-flex align-items-start gap-3">
                <i class="bi bi-info-circle fs-4"></i>
                <div>
                    <div class="fw-semibold">File format detected</div>
                    <div class="small mb-1">Delimiter identified as <code>{{ detected_delimiter }}</code>.
                        {% if detected_delimiter == ';' %} Common in European CSV files.
                        {% elif detected_delimiter == ',' %} Standard comma-separated format.
                        {% elif detected_delimiter == '\t' %} Tab-separated values.
                        {% endif %}
                    </div>
                </div>
            </div>
            {% endif %}

            <div class="card shadow-sm">
                <div class="card-header bg-light fw-semibold">
                    <i class="bi bi-columns-gap me-2"></i>Column Selection
                </div>
                <div class="card-body">
                    <p class="mb-4">Choose which CSV column acts as the unique identifier and optionally confirm the coordinate system.</p>

                    <form method="post" class="d-flex flex-column gap-4">
                        {% csrf_token %}
                        <div>
                            <label for="id_column" class="form-label">ID Column <span class="text-danger">*</span></label>
                            <select class="form-select" id="id_column" name="id_column" required>
                                <option value="">-- Select ID Column --</option>
                                {% for header in headers %}
                                <option value="{{ header }}">{{ header }}</option>
                                {% endfor %}
                            </select>
                            <div class="form-text">Must contain unique values; each row becomes a geometry keyed by this column.</div>
                        </div>

                        <div>
                            <label for="coordinate_system" class="form-label">Coordinate System (Optional)</label>
                            <select class="form-select" id="coordinate_system" name="coordinate_system">
                                <option value="auto">Auto-detect (recommended)</option>
                                <option value="4326">WGS84 (EPSG:4326)</option>
                                <option value="31256">MGI Austria GK M34 (EPSG:31256)</option>
                                <option value="31257">MGI Austria GK M31 (EPSG:31257)</option>
                                <option value="31258">MGI Austria GK M28 (EPSG:31258)</option>
                                <option value="3857">Web Mercator (EPSG:3857)</option>
                            </select>
                            <div class="form-text">Leave as auto to let the importer detect and transform coordinates.</div>
                        </div>

                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="clear_existing" name="clear_existing">
                            <label class="form-check-label fw-semibold" for="clear_existing">Clear existing data before import</label>
                            <div class="form-text text-warning">
                                <i class="bi bi-exclamation-triangle me-1"></i>This permanently deletes all geometries and entries in the dataset before importing.
                            </div>
                        </div>

                        <div class="d-flex flex-wrap gap-2 justify-content-end">
                            <a href="{% url 'dataset_detail' dataset.id %}" class="btn btn-outline-secondary">
                                <i class="bi bi-x-circle"></i> Cancel
                            </a>
                            <button type="submit" class="btn btn-primary">
                                <i class="bi bi-cloud-upload"></i> Import Data
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>

        <div class="col-lg-4">
            <div class="card shadow-sm mb-4">
                <div class="card-header bg-light fw-semibold">
                    <i class="bi bi-table me-2"></i>Available Columns
                </div>
                <div class="card-body small text-muted">
                    <p class="mb-3">{{ headers|length }} columns detected in your CSV file.</p>
                    <ul class="list-group list-group-flush">
                        {% for header in headers %}
                        <li class="list-group-item d-flex justify-content-between align-items-center">
                            <span class="text-break">{{ header }}</span>
                            <span class="badge bg-secondary">{{ forloop.counter }}</span>
                        </li>
                        {% endfor %}
                    </ul>
                </div>
            </div>

            <div class="card shadow-sm">
                <div class="card-header bg-light fw-semibold">
                    <i class="bi bi-lightbulb me-2"></i>Column Guidance
                </div>
                <div class="card-body small text-muted">
                    <p class="mb-2"><strong>ID Column</strong>: ensure this column has no duplicates.</p>
                    <p class="mb-2"><strong>Coordinate Columns</strong> are auto-detected from: <code>GEB_X/GEB_Y</code>, <code>X/Y</code>, <code>LONGITUDE/LATITUDE</code>, <code>LON/LAT</code>.</p>
                    <p class="mb-0"><strong>Address Column</strong>: <code>ADRESSE</code> (optional). Used for descriptive summaries.</p>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const idColumnSelect = document.getElementById('id_column');
    const commonIdNames = ['ID', 'id', 'Id', 'ID_KURZ', 'id_kurz', 'Id_Kurz', 'GEOMETRY_ID', 'geometry_id'];

    if (idColumnSelect) {
        for (let i = 0; i < idColumnSelect.options.length; i++) {
            const option = idColumnSelect.options[i];
            if (commonIdNames.includes(option.value)) {
                option.selected = true;
                break;
            }
        }
    }
});
</script>
{% endblock %}
