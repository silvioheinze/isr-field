{% extends 'datasets/_base.html' %}
{% load dataset_extras %}

{% block title %}Edit Entry - ISR Field{% endblock %}

{% block content %}
<div class="container mt-4" style="max-width: 800px;">
    <h2>Edit Entry: {{ entry.name }}</h2>
    <p class="text-muted">Geometry: {{ entry.geometry.id_kurz }} - {{ entry.geometry.address }}</p>
    <p class="text-muted">Created by: {{ entry.user.username|default:"Unknown" }}</p>
    
    <form method="post">
        {% csrf_token %}
        <div class="row">
            <div class="col-md-6">
                <div class="mb-3">
                    <label for="name" class="form-label">Name</label>
                    <input type="text" class="form-control" id="name" name="name" value="{{ entry.name }}" required>
                </div>
            </div>
            <div class="col-md-6">
                <div class="mb-3">
                    <label for="year" class="form-label">Year</label>
                    <input type="number" class="form-control" id="year" name="year" value="{{ entry.year }}" required>
                </div>
            </div>
        </div>
        
        <!-- Dynamic Fields -->
        {% for field in all_fields %}
            {% if field.enabled %}
                <div class="mb-3">
                    <label for="{{ field.field_name }}" class="form-label">{{ field.label }}
                        {% if field.required %}<span class="text-danger">*</span>{% endif %}
                    </label>
                    {% if field.field_type == 'text' %}
                        <input type="text" class="form-control" id="{{ field.field_name }}" name="{{ field.field_name }}" 
                               value="{{ entry|get_field_value:field.field_name }}" 
                               {% if field.required %}required{% endif %}
                               {% if field.non_editable %}readonly{% endif %}>
                    {% elif field.field_type == 'integer' %}
                        <input type="number" class="form-control" id="{{ field.field_name }}" name="{{ field.field_name }}" 
                               value="{{ entry|get_field_value:field.field_name }}" 
                               {% if field.required %}required{% endif %}
                               {% if field.non_editable %}readonly{% endif %}>
                    {% elif field.field_type == 'decimal' %}
                        <input type="number" step="0.01" class="form-control" id="{{ field.field_name }}" name="{{ field.field_name }}" 
                               value="{{ entry|get_field_value:field.field_name }}" 
                               {% if field.required %}required{% endif %}
                               {% if field.non_editable %}readonly{% endif %}>
                    {% elif field.field_type == 'boolean' %}
                        <select class="form-control" id="{{ field.field_name }}" name="{{ field.field_name }}" 
                                {% if field.required %}required{% endif %}
                                {% if field.non_editable %}disabled{% endif %}>
                            <option value="">Select option</option>
                            <option value="true" {% if entry|get_field_value:field.field_name == 'true' %}selected{% endif %}>Yes</option>
                            <option value="false" {% if entry|get_field_value:field.field_name == 'false' %}selected{% endif %}>No</option>
                        </select>
                        {% if field.non_editable %}
                            <input type="hidden" name="{{ field.field_name }}" value="{{ entry|get_field_value:field.field_name }}">
                        {% endif %}
                    {% elif field.field_type == 'date' %}
                        <input type="date" class="form-control" id="{{ field.field_name }}" name="{{ field.field_name }}" 
                               value="{{ entry|get_field_value:field.field_name }}" 
                               {% if field.required %}required{% endif %}
                               {% if field.non_editable %}readonly{% endif %}>
                    {% elif field.field_type == 'choice' %}
                        <select class="form-control" id="{{ field.field_name }}" name="{{ field.field_name }}" 
                                {% if field.required %}required{% endif %}
                                {% if field.non_editable %}disabled{% endif %}>
                            <option value="">Select option</option>
                            {% for choice in field|get_choices_list %}
                                {% if choice.value %}
                                    <option value="{{ choice.value }}" {% if entry|get_field_value:field.field_name == choice.value %}selected{% endif %}>{{ choice.label }}</option>
                                {% else %}
                                    <option value="{{ choice }}" {% if entry|get_field_value:field.field_name == choice %}selected{% endif %}>{{ choice }}</option>
                                {% endif %}
                            {% endfor %}
                        </select>
                        {% if field.non_editable %}
                            <input type="hidden" name="{{ field.field_name }}" value="{{ entry|get_field_value:field.field_name }}">
                        {% endif %}
                    {% else %}
                        <input type="text" class="form-control" id="{{ field.field_name }}" name="{{ field.field_name }}" 
                               value="{{ entry|get_field_value:field.field_name }}" 
                               {% if field.required %}required{% endif %}
                               {% if field.non_editable %}readonly{% endif %}>
                    {% endif %}
                    {% if field.help_text %}
                        <div class="form-text">{{ field.help_text }}</div>
                    {% endif %}
                </div>
            {% endif %}
        {% endfor %}
        
        <button type="submit" class="btn btn-primary">Save Changes</button>
        <a href="{% url 'dataset_data_input' entry.geometry.dataset.id %}" class="btn btn-secondary">Cancel</a>
    </form>
</div>
{% endblock %} 