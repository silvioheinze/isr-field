{% extends 'datasets/_base.html' %}
{% load i18n %}
{% load dataset_extras %}

{% block title %}{{ dataset.name }} - {% trans "Export Files" %}{% endblock %}

{% block content %}
<div class="container py-4">
    <div class="d-flex flex-column flex-lg-row align-items-lg-center justify-content-between gap-3 mb-4">
        <div>
            <h1 class="h3 mb-1"><i class="bi bi-download me-2"></i>{% trans "Export Files" %}</h1>
            <div class="text-muted small">
                <span class="me-2">{{ dataset.name }}</span>
                <span class="badge bg-info text-dark">{{ stats.total_files }} {% trans "files" %}</span>
                <span class="badge bg-secondary ms-1">{{ stats.total_size|filesizeformat }}</span>
            </div>
        </div>
        <div class="d-flex flex-wrap gap-2">
            <a href="{% url 'dataset_detail' dataset.id %}" class="btn btn-outline-secondary btn-sm">
                <i class="bi bi-arrow-left"></i> {% trans "Back to Dataset" %}
            </a>
        </div>
    </div>

    <div class="row g-4">
        <div class="col-lg-8">
            <div class="card shadow-sm mb-4">
                <div class="card-header bg-light fw-semibold">
                    <i class="bi bi-gear me-2"></i>{% trans "Export Options" %}
                </div>
                <div class="card-body">
                    <form id="exportForm" method="post" action="{% url 'export_files_zip' dataset.id %}" class="row g-4">
                        {% csrf_token %}
                        <div class="col-md-6">
                            <label for="file_types" class="form-label">{% trans "File Types" %}</label>
                            <select class="form-select" id="file_types" name="file_types" multiple>
                                {% for option in file_types %}
                                <option value="{{ option.value }}" selected>{{ option.label }}</option>
                                {% endfor %}
                            </select>
                            <div class="form-text">{% trans "Select which file types to include." %}</div>
                        </div>
                        <div class="col-md-6">
                            <label for="organize_by" class="form-label">{% trans "Organization Method" %}</label>
                            <select class="form-select" id="organize_by" name="organize_by">
                                {% for option in organize_options %}
                                <option value="{{ option.value }}">{{ option.label }}</option>
                                {% endfor %}
                            </select>
                            <div class="form-text">{% trans "Choose how exported files are grouped." %}</div>
                        </div>

                        <div class="col-md-6">
                            <label for="date_from" class="form-label">{% trans "From Date" %}</label>
                            <input type="date" class="form-control" id="date_from" name="date_from">
                            <div class="form-text">{% trans "Only include files uploaded on or after this date." %}</div>
                        </div>
                        <div class="col-md-6">
                            <label for="date_to" class="form-label">{% trans "To Date" %}</label>
                            <input type="date" class="form-control" id="date_to" name="date_to">
                            <div class="form-text">{% trans "Only include files uploaded on or before this date." %}</div>
                        </div>

                        <div class="col-12">
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" id="include_metadata" name="include_metadata" checked>
                                <label class="form-check-label fw-semibold" for="include_metadata">{% trans "Include Metadata" %}</label>
                                <div class="form-text">{% trans "Add CSV and JSON manifests to the export package." %}</div>
                            </div>
                        </div>

                        <div class="col-12">
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" id="email_notification" name="email_notification" checked>
                                <label class="form-check-label fw-semibold" for="email_notification">{% trans "Send Email Notification" %}</label>
                                <div class="form-text">{% trans "Receive an email when the ZIP file is ready." %}</div>
                            </div>
                        </div>

                        <div class="col-12 d-flex flex-wrap gap-2 justify-content-end pt-2">
                            <button type="submit" class="btn btn-success">
                                <i class="bi bi-file-zip"></i> {% trans "Export ZIP" %}
                            </button>
                        </div>
                    </form>
                </div>
            </div>

            {% if recent_files %}
            <div class="card shadow-sm">
                <div class="card-header bg-light fw-semibold">
                    <i class="bi bi-clock-history me-2"></i>{% trans "Recent Files" %}
                </div>
                <div class="card-body p-0">
                    <div class="table-responsive">
                        <table class="table table-hover table-sm mb-0 align-middle">
                            <thead class="table-light">
                                <tr>
                                    <th>{% trans "File" %}</th>
                                    <th>{% trans "Type" %}</th>
                                    <th>{% trans "Size" %}</th>
                                    <th>{% trans "Uploaded" %}</th>
                                    <th>{% trans "User" %}</th>
                                    <th>{% trans "Geometry" %}</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for file in recent_files %}
                                <tr>
                                    <td class="text-break"><i class="bi bi-file-earmark me-2"></i>{{ file.filename }}</td>
                                    <td><span class="badge bg-secondary">{{ file.file_type }}</span></td>
                                    <td>{{ file.file_size|filesizeformat }}</td>
                                    <td>{{ file.upload_date|date:"M d, Y H:i" }}</td>
                                    <td>{{ file.upload_user.username|default:"Unknown" }}</td>
                                    <td>{{ file.entry.geometry.id_kurz }}</td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
            {% endif %}
        </div>

        <div class="col-lg-4">
            <div class="card shadow-sm mb-4">
                <div class="card-header bg-light fw-semibold">
                    <i class="bi bi-bar-chart me-2"></i>{% trans "File Statistics" %}
                </div>
                <div class="card-body small text-muted">
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <div>
                            <div class="fw-semibold">{% trans "Total Files" %}</div>
                            <div>{{ stats.total_files }}</div>
                        </div>
                        <div class="text-end">
                            <div class="fw-semibold">{% trans "Total Size" %}</div>
                            <div>{{ stats.total_size|filesizeformat }}</div>
                        </div>
                    </div>

                    {% if stats.file_types %}
                    <div class="mb-3">
                        <div class="fw-semibold mb-1">{% trans "File Types" %}</div>
                        {% for file_type, count in stats.file_types.items %}
                        <div class="d-flex justify-content-between py-1 border-bottom border-light">
                            <span>{{ file_type|title }}</span>
                            <span class="badge bg-light text-dark">{{ count }}</span>
                        </div>
                        {% endfor %}
                    </div>
                    {% endif %}

                    {% if stats.users %}
                    <div class="mb-3">
                        <div class="fw-semibold mb-1">{% trans "Contributing Users" %}</div>
                        {% for user, count in stats.users.items %}
                        <div class="d-flex justify-content-between py-1 border-bottom border-light">
                            <span>{{ user }}</span>
                            <span class="badge bg-light text-dark">{{ count }}</span>
                        </div>
                        {% endfor %}
                    </div>
                    {% endif %}

                    {% if stats.date_range.earliest and stats.date_range.latest %}
                    <div>
                        <div class="fw-semibold mb-1">{% trans "Date Range" %}</div>
                        <p class="small mb-0">{{ stats.date_range.earliest|date:"M d, Y" }} â€“ {{ stats.date_range.latest|date:"M d, Y" }}</p>
                    </div>
                    {% endif %}
                </div>
            </div>

            <div class="card shadow-sm">
                <div class="card-header bg-info text-dark fw-semibold">
                    <i class="bi bi-lightbulb me-2"></i>{% trans "Tips" %}
                </div>
                <div class="card-body small text-muted">
                    <h6 class="fw-semibold">{% trans "Export Formats" %}</h6>
                    <ul class="ps-3 mb-3">
                        <li><strong>ZIP:</strong> {% trans "All files packaged with manifests." %}</li>
                        <li><strong>CSV:</strong> {% trans "Spreadsheet-friendly manifest." %}</li>
                        <li><strong>JSON:</strong> {% trans "Machine-readable manifest for integrations." %}</li>
                    </ul>

                    <h6 class="fw-semibold">{% trans "Organization Methods" %}</h6>
                    <ul class="ps-3 mb-0">
                        <li><strong>{% trans "By Geometry" %}:</strong> {% trans "Group files under geometry IDs." %}</li>
                        <li><strong>{% trans "By Entry" %}:</strong> {% trans "Split by data entry." %}</li>
                        <li><strong>{% trans "By Date" %}:</strong> {% trans "Bundle by upload date." %}</li>
                        <li><strong>{% trans "By User" %}:</strong> {% trans "Organize by uploader." %}</li>
                        <li><strong>{% trans "By Type" %}:</strong> {% trans "Separate by file type." %}</li>
                    </ul>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const today = new Date();
    const lastMonth = new Date(today.getFullYear(), today.getMonth() - 1, today.getDate());
    const fromInput = document.getElementById('date_from');
    const toInput = document.getElementById('date_to');

    if (fromInput && toInput) {
        fromInput.value = lastMonth.toISOString().split('T')[0];
        toInput.value = today.toISOString().split('T')[0];
    }
});
</script>
{% endblock %}
