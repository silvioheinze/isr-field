{% extends 'datasets/_base.html' %}

{% block title %}Import CSV - {{ dataset.name }}{% endblock %}

{% block content %}
<div class="container py-4">
    <div class="d-flex flex-column flex-lg-row align-items-lg-center justify-content-between gap-3 mb-4">
        <div>
            <h1 class="h3 mb-1">Import CSV Data</h1>
            <p class="text-muted small mb-0">Upload a CSV to populate <strong>{{ dataset.name }}</strong> with geometries and entries.</p>
        </div>
        <div class="d-flex flex-wrap gap-2">
            <a href="{% url 'dataset_detail' dataset.id %}" class="btn btn-outline-secondary btn-sm">
                <i class="bi bi-arrow-left"></i> Back to Dataset
            </a>
        </div>
    </div>

    <div class="row g-4">
        <div class="col-lg-8">
            <div class="card shadow-sm mb-4">
                <div class="card-header bg-light fw-semibold">
                    <i class="bi bi-diagram-3 me-2"></i>CSV Format Requirements
                </div>
                <div class="card-body">
                    <p class="mb-3">Ensure your CSV contains the following columns for a successful import:</p>
                    <ul class="mb-4">
                        <li><strong>ID</strong> – Unique identifier for each geometry point.</li>
                        <li><strong>ADRESSE</strong> – Location address (optional if defaults exist).</li>
                        <li><strong>Coordinate pairs</strong> – Include one of these combinations:
                            <ul>
                                <li><strong>GEB_X</strong> &amp; <strong>GEB_Y</strong> – Austrian coordinates.</li>
                                <li><strong>X</strong> &amp; <strong>Y</strong> – Generic projected coordinates.</li>
                                <li><strong>LONGITUDE</strong> &amp; <strong>LATITUDE</strong> – WGS84 coordinates.</li>
                                <li><strong>LON</strong> &amp; <strong>LAT</strong> – Short-form WGS84.</li>
                            </ul>
                        </li>
                        <li><strong>Year-prefixed columns</strong> – e.g. <code>2016_NUTZUNG</code>, <code>2022_CAT_INNO</code>, <code>2020_CAT_WERT</code>.</li>
                        <li><strong>Generic columns</strong> – e.g. <code>NUTZUNG</code>, <code>NUTZUNG_POLY1</code>, <code>CAT_INNO</code>, <code>YEAR</code> (optional).
                    </ul>

                    <h6 class="fw-semibold">Supported Coordinate Systems</h6>
                    <ul>
                        <li><strong>WGS84 (EPSG:4326)</strong> – Latitude/Longitude.</li>
                        <li><strong>MGI Austria GK M34/M31/M28 (EPSG:31256/31257/31258)</strong> – Austrian projected coordinates.</li>
                        <li><strong>Web Mercator (EPSG:3857)</strong> – Web mapping coordinates.</li>
                    </ul>

                    <h6 class="fw-semibold mt-3">Enhanced Auto-Detection</h6>
                    <p class="small text-muted mb-2">Coordinate systems are detected automatically based on value ranges:</p>
                    <ul class="small mb-4">
                        <li><strong>WGS84</strong>: Latitude 47–49°, Longitude 9–18°.</li>
                        <li><strong>MGI GK M34</strong>: X 500 000–900 000, Y 3 000 000–5 000 000.</li>
                        <li><strong>MGI GK M31</strong>: X 300 000–700 000, Y 3 000 000–5 000 000.</li>
                        <li><strong>MGI GK M28</strong>: X 100 000–500 000, Y 3 000 000–5 000 000.</li>
                        <li><strong>Scaled Austrian</strong>: X 100–2 000, Y 330 000–350 000.</li>
                    </ul>

                    <div class="alert alert-info mb-0">
                        <ul class="mb-0 small">
                            <li><strong>Data creation:</strong> Each year-specific column creates a separate entry; generic columns create a single entry when no year columns exist.</li>
                            <li><strong>Existing IDs:</strong> Rows with geometry IDs that already exist are skipped to avoid duplicates.</li>
                            <li><strong>Entry names:</strong> Use <code>{YEAR}_NUTZUNG_NAME</code> or <code>NUTZUNG_NAME</code> to label entries. Otherwise, names remain blank.</li>
                            <li><strong>Coordinate transforms:</strong> Multiple Austrian projections are transformed to WGS84 automatically.</li>
                        </ul>
                    </div>
                </div>
            </div>

            <div class="card shadow-sm">
                <div class="card-header bg-light fw-semibold">
                    <i class="bi bi-upload me-2"></i>Upload CSV File
                </div>
                <div class="card-body">
                    <form method="post" enctype="multipart/form-data" class="d-flex flex-column gap-3">
                        {% csrf_token %}
                        <div>
                            <label for="csv_file" class="form-label">Select CSV File</label>
                            <input type="file" class="form-control" id="csv_file" name="csv_file" accept=".csv" required>
                            <div class="form-text">Only comma-separated CSV files are accepted.</div>
                        </div>
                        <div class="d-flex flex-wrap gap-2 justify-content-end">
                            <a href="{% url 'dataset_detail' dataset.id %}" class="btn btn-outline-secondary">
                                <i class="bi bi-x-circle"></i> Cancel
                            </a>
                            <button type="submit" class="btn btn-primary">
                                <i class="bi bi-arrow-right-circle"></i> Next: Select Columns
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>

        <div class="col-lg-4">
            <div class="card shadow-sm mb-4">
                <div class="card-header bg-light fw-semibold">
                    <i class="bi bi-lightbulb me-2"></i>Tips before Importing
                </div>
                <div class="card-body small text-muted">
                    <ul class="ps-3 mb-0">
                        <li class="mb-2">Clean spreadsheets of extra header rows or merged cells.</li>
                        <li class="mb-2">Verify coordinate formats are consistent throughout the file.</li>
                        <li class="mb-2">Keep a backup of your CSV in case you need to re-import.</li>
                        <li>Consider importing a small sample first to validate the structure.</li>
                    </ul>
                </div>
            </div>

            <div class="card shadow-sm mb-4">
                <div class="card-header bg-light fw-semibold">
                    <i class="bi bi-clipboard-data me-2"></i>Quick Access
                </div>
                <div class="card-body d-grid gap-2">
                    <a href="{% url 'dataset_data_input' dataset.id %}" class="btn btn-outline-primary btn-sm">
                        <i class="bi bi-pencil-square"></i> Data Input
                    </a>
                    {% if dataset.owner == user %}
                    <a href="{% url 'dataset_edit' dataset.id %}" class="btn btn-outline-warning btn-sm">
                        <i class="bi bi-gear"></i> Edit Dataset
                    </a>
                    {% endif %}
                </div>
            </div>

            <div class="card shadow-sm">
                <div class="card-header bg-light fw-semibold">
                    <i class="bi bi-file-earmark-spreadsheet me-2"></i>Sample CSV Format
                </div>
                <div class="card-body">
                    <small class="text-muted">
<pre class="mb-3">ID,ADRESSE,2016_NUTZUNG,2016_CAT_INNO,2016_CAT_WERT,2016_CAT_FILI,2016_NUTZUNG_NAME,GEB_X,GEB_Y,2022_NUTZUNG,2022_CAT_INNO,2022_CAT_WERT,2022_CAT_FILI,2022_NUTZUNG_NAME
ss16_kg01_001_1,Apollogasse 19,870,999,999,999,Residential Building,656.61,339913.14,870,999,999,999,Office Building
ss16_kg01_001_2,Apollogasse 28,640,0,0,0,Commercial Space,636.41,339972.43,640,0,0,0,Retail Store

Alternative coordinates:
ID,ADRESSE,LONGITUDE,LATITUDE,2016_NUTZUNG,2016_CAT_INNO,2016_NUTZUNG_NAME
point_001,Test Address,16.3738,48.2082,870,999,Residential Building

Generic format:
ID,ADRESSE,X,Y,NUTZUNG,CAT_INNO,CAT_WERT,NUTZUNG_NAME,YEAR
point_002,Another Address,656610,3399131,870,999,999,Office Building,2022</pre>
                    </small>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}
