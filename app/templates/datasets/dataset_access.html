{% extends 'datasets/_base.html' %}
{% load i18n %}

{% block title %}Manage Access - {{ dataset.name }}{% endblock %}

{% block content %}
<div class="container py-4" style="max-width: 900px;">
    <div class="d-flex flex-column flex-lg-row align-items-lg-center justify-content-between gap-3 mb-4">
        <div>
            <h1 class="h3 mb-1">Manage Access</h1>
            <p class="text-muted small mb-0">Choose the users and groups that can collaborate on <strong>{{ dataset.name }}</strong>.</p>
        </div>
        <div class="d-flex flex-wrap gap-2">
            <a href="{% url 'dataset_detail' dataset.id %}" class="btn btn-outline-secondary btn-sm">
                <i class="bi bi-arrow-left"></i> Back to Dataset
            </a>
        </div>
    </div>

    <form method="post" novalidate>
        {% csrf_token %}
        <div class="row g-4">
            <div class="col-lg-6">
                <div class="card shadow-sm h-100">
                    <div class="card-header bg-light fw-semibold">
                        <i class="bi bi-person-plus me-2"></i>Share with Users
                    </div>
                    <div class="card-body">
                        {% if all_users %}
                            <div class="d-flex flex-column gap-3">
                                {% for user in all_users %}
                                <div class="border rounded p-2">
                                    <div class="form-check">
                                        <input class="form-check-input" type="checkbox" name="shared_users" value="{{ user.id }}" id="user{{ user.id }}"
                                               data-access-checkbox="user" data-target="#userMappingAreas{{ user.id }}"
                                               {% if user.id in shared_users %}checked{% endif %}>
                                        <label class="form-check-label fw-semibold" for="user{{ user.id }}">
                                            {{ user.username }}
                                            {% if user.first_name or user.last_name %}
                                                <span class="text-muted small">({{ user.first_name }} {{ user.last_name }})</span>
                                            {% endif %}
                                        </label>
                                    </div>
                                    {% if mapping_areas %}
                                    <div class="mapping-area-limit mt-2">
                                        <label class="form-label small mb-1" for="userMappingAreas{{ user.id }}">Limit to mapping areas</label>
                                        <select class="form-select form-select-sm" name="user_mapping_areas_{{ user.id }}" id="userMappingAreas{{ user.id }}" multiple {% if user.id not in shared_users %}disabled{% endif %}>
                                            {% for area in mapping_areas %}
                                            <option value="{{ area.id }}" {% if area.id in user.mapping_area_ids %}selected{% endif %}>{{ area.name }}</option>
                                            {% endfor %}
                                        </select>
                                        <div class="form-text small">Leave empty to grant access to the entire dataset.</div>
                                    </div>
                                    {% endif %}
                                </div>
                                {% empty %}
                                <p class="text-muted small mb-0">No additional users are available at the moment.</p>
                                {% endfor %}
                            </div>
                        {% endif %}
                    </div>
                </div>
            </div>

            <div class="col-lg-6">
                <div class="card shadow-sm h-100">
                    <div class="card-header bg-light fw-semibold">
                        <i class="bi bi-people me-2"></i>Share with Groups
                    </div>
                    <div class="card-body">
                        {% if all_groups %}
                            <div class="d-flex flex-column gap-3">
                                {% for group in all_groups %}
                                <div class="border rounded p-2">
                                    <div class="form-check">
                                        <input class="form-check-input" type="checkbox" name="shared_groups" value="{{ group.id }}" id="group{{ group.id }}"
                                               data-access-checkbox="group" data-target="#groupMappingAreas{{ group.id }}"
                                               {% if group.id in shared_groups %}checked{% endif %}>
                                        <label class="form-check-label fw-semibold" for="group{{ group.id }}">
                                            {{ group.name }}
                                            <span class="text-muted small">({{ group.user_set.count }} user{{ group.user_set.count|pluralize }})</span>
                                        </label>
                                    </div>
                                    {% if mapping_areas %}
                                    <div class="mapping-area-limit mt-2">
                                        <label class="form-label small mb-1" for="groupMappingAreas{{ group.id }}">Limit to mapping areas</label>
                                        <select class="form-select form-select-sm" name="group_mapping_areas_{{ group.id }}" id="groupMappingAreas{{ group.id }}" multiple {% if group.id not in shared_groups %}disabled{% endif %}>
                                            {% for area in mapping_areas %}
                                            <option value="{{ area.id }}" {% if area.id in group.mapping_area_ids %}selected{% endif %}>{{ area.name }}</option>
                                            {% endfor %}
                                        </select>
                                        <div class="form-text small">Leave empty to grant this group access to the entire dataset.</div>
                                    </div>
                                    {% endif %}
                                </div>
                                {% empty %}
                                <p class="text-muted small mb-0">No groups available yet.</p>
                                {% endfor %}
                            </div>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>

        <div class="d-flex flex-wrap gap-2 justify-content-end mt-4">
            <a href="{% url 'dataset_detail' dataset.id %}" class="btn btn-outline-secondary">
                <i class="bi bi-x-circle"></i> Cancel
            </a>
            <button type="submit" class="btn btn-primary">
                <i class="bi bi-save"></i> Save Access Settings
            </button>
        </div>
    </form>

    <div class="card shadow-sm mt-4">
        <div class="card-header bg-light fw-semibold">
            <i class="bi bi-info-circle me-2"></i>Access Summary
        </div>
        <div class="card-body small text-muted">
            <ul class="ps-3 mb-0">
                <li><strong>Owner:</strong> {{ dataset.owner.username }} {% trans "always has access." %}</li>
                <li><strong>Users:</strong> Selected individuals gain direct access.</li>
                <li><strong>Groups:</strong> All members inherit access from selected groups.</li>
                <li><strong>Public:</strong> {% if dataset.is_public %}Yes – anyone can view this dataset.{% else %}No – only invited collaborators can view it.{% endif %}</li>
            </ul>
        </div>
    </div>
</div>
{% endblock %} 

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function () {
    document.querySelectorAll('[data-access-checkbox]').forEach(function (checkbox) {
        var targetSelector = checkbox.getAttribute('data-target');
        if (!targetSelector) {
            return;
        }
        var select = document.querySelector(targetSelector);
        if (!select) {
            return;
        }
        var container = select.closest('.mapping-area-limit');

        var syncState = function () {
            var enabled = checkbox.checked;
            select.disabled = !enabled;
            if (container) {
                container.classList.toggle('opacity-50', !enabled);
            }
        };

        checkbox.addEventListener('change', syncState);
        syncState();
    });
});
</script>
{% endblock %}